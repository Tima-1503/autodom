<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление работами</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            padding: 0;
            background-color: #f8f9fa;
            font-size: 14px;
            margin: 0;
        }
        .container-fluid {
            width: 100%;
            padding: 10px;
        }
        h1, h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        .table th, .table td {
            padding: 6px;
            vertical-align: middle;
        }
        .table-hover tbody tr:hover {
            background-color: #e9ecef;
            cursor: pointer;
        }
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .timer {
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .negative {
            color: red;
        }
        .disabled-table {
            pointer-events: none;
            opacity: 0.6;
        }
        .alert {
            font-size: 0.9rem;
            padding: 8px;
            margin-top: 10px;
        }
        .btn {
            font-size: 0.9rem;
            padding: 5px 10px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .paused-works {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center">Управление работами</h1>

        <div class="mb-3">
            <label for="executor" class="form-label">Сотрудник:</label>
            <select class="form-select" id="executor">
                <option value="">Выберите сотрудника</option>
                {% for worker in workerssarray %}
                    <option value="{{ worker.Code }}">{{ worker.Worker }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3 class="text-center">Заказы</h3>
                <div class="table-container">
                    <table class="table table-bordered table-hover" id="ordersTable">
                        <thead class="table-light">
                            <tr>
                                <th>Номер</th>
                                <th>Описание</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6">
                <h3 class="text-center">Работы</h3>
                <div class="table-container">
                    <table class="table table-bordered table-hover" id="worksTable">
                        <thead class="table-light">
                            <tr>
                                <th>Выбор</th>
                                <th>Описание</th>
                                <th>Время</th>
                            </tr>
                        </thead>
                        <tbody id="worksList"></tbody>
                    </table>
                </div>
                <div class="paused-works">
                    <h3 class="text-center">Работы на паузе</h3>
                    <div class="table-container">
                        <table class="table table-bordered table-hover" id="pausedWorksTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Выбор</th>
                                    <th>Описание</th>
                                    <th>Осталось</th>
                                </tr>
                            </thead>
                            <tbody id="pausedWorksList"></tbody>
                        </table>
                    </div>
                </div>
                <div id="timerDisplay" class="timer text-center"></div>
                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
                <div class="mt-2 text-center">
                    <button class="btn btn-primary me-1" id="startButton" onclick="startWork()" disabled>Начать</button>
                    <button class="btn btn-secondary me-1" id="pauseButton" onclick="togglePause()" disabled>Пауза</button>
                    <button class="btn btn-success" id="finishButton" onclick="finishWork()" disabled>Завершить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для выбора причины паузы -->
    <div class="modal fade" id="pauseReasonModal" tabindex="-1" aria-labelledby="pauseReasonModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pauseReasonModalLabel">Выберите причину паузы</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="pauseReasonsContainer">
                    <!-- Причины будут добавлены динамически -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="confirmPause">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения завершения -->
    <div class="modal fade" id="finishConfirmationModal" tabindex="-1" aria-labelledby="finishConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="finishConfirmationModalLabel">Подтверждение завершения</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Вы уверены, что хотите завершить работу?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelFinish" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="confirmFinish">ОК</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        const sessions = {};
        let currentSessionKey = null;
        let selectedOrderDescription = null;
        let selectedOrder = null;
        let selectedWork = null;

        function loadPauseReasons() {
            fetch('/get_pause_reasons/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('pauseReasonsContainer');
                container.innerHTML = '';
                if (data.pause_reasons && data.pause_reasons.length > 0) {
                    data.pause_reasons.forEach((reason, index) => {
                        const div = document.createElement('div');
                        div.classList.add('form-check');
                        div.innerHTML = `
                            <input class="form-check-input" type="radio" name="pauseReason" id="reason${reason.code}" value="${reason.code}" ${index === 0 ? 'checked' : ''}>
                            <label class="form-check-label" for="reason${reason.code}">${reason.code}. ${reason.description}</label>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<p>Причины пауз не найдены.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading pause reasons:', error);
                const container = document.getElementById('pauseReasonsContainer');
                container.innerHTML = '<p>Ошибка загрузки причин пауз.</p>';
            });
        }

        function updateInterfaceLock() {
            const ordersTable = document.getElementById('ordersTable');
            const pausedWorksTable = document.getElementById('pausedWorksTable');
            const hasActiveWork = Object.values(sessions).some(session => !session.isPaused);
            const startButton = document.getElementById('startButton');
            const pauseButton = document.getElementById('pauseButton');
            const finishButton = document.getElementById('finishButton');

            if (hasActiveWork) {
                ordersTable.classList.add('disabled-table');
                pausedWorksTable.classList.add('disabled-table');
                if (currentSessionKey && sessions[currentSessionKey] && !sessions[currentSessionKey].isPaused) {
                    startButton.disabled = true;
                    pauseButton.disabled = false;
                    pauseButton.textContent = 'Пауза';
                    finishButton.disabled = false;
                } else {
                    startButton.disabled = true;
                    pauseButton.disabled = true;
                    pauseButton.textContent = 'Пауза';
                    finishButton.disabled = true;
                }
            } else {
                ordersTable.classList.remove('disabled-table');
                pausedWorksTable.classList.remove('disabled-table');
                startButton.disabled = !selectedWork;
                pauseButton.disabled = true;
                pauseButton.textContent = 'Пауза';
                finishButton.disabled = true;
            }
        }

        function fetchOrders() {
            const executorCode = document.getElementById('executor').value;
            const executorName = document.getElementById('executor').options[document.getElementById('executor').selectedIndex].text;
            if (executorCode) {
                console.log('Fetching orders for:', executorName);
                Object.keys(sessions).forEach(key => {
                    if (sessions[key].timerInterval) clearInterval(sessions[key].timerInterval);
                    delete sessions[key];
                });
                currentSessionKey = null;
                selectedWork = null;
                selectedOrder = null;
                selectedOrderDescription = null;
                document.getElementById('worksList').innerHTML = '';
                document.getElementById('pausedWorksList').innerHTML = '';
                document.getElementById('timerDisplay').textContent = '';
                document.getElementById('errorMessage').style.display = 'none';
                resetTimer(null);

                fetch('/get_orders/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: 'executor_name=' + encodeURIComponent(executorName)
                })
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('ordersTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    if (data.orders && data.orders.length > 0) {
                        data.orders.forEach(order => {
                            const row = document.createElement('tr');
                            row.classList.add('fade-in');
                            row.innerHTML = `
                                <td>${order.OrderNumber}</td>
                                <td>${order.Order}${order.Car ? '<br>' + order.Car : ''}</td>
                            `;
                            row.onclick = () => {
                                const hasActiveWork = Object.values(sessions).some(s => !s.isPaused);
                                if (hasActiveWork && sessions[currentSessionKey].orderNumber !== order.OrderNumber) {
                                    const errorMessage = document.getElementById('errorMessage');
                                    errorMessage.textContent = 'Завершите или поставьте на паузу текущую работу перед выбором другого заказа.';
                                    errorMessage.style.display = 'block';
                                    return;
                                }
                                selectedOrder = order.OrderNumber;
                                selectedOrderDescription = `${order.Order}${order.Car ? ', ' + order.Car : ''}`;
                                selectedWork = null;
                                document.querySelectorAll('#ordersTable tr').forEach(r => r.classList.remove('table-active'));
                                row.classList.add('table-active');
                                fetchWorks(order.OrderNumber, executorName);
                            };
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="2">Нет доступных заказов</td></tr>';
                    }
                    // Проверяем активные сессии после загрузки заказов
                    checkActiveSession(executorName);
                })
                .catch(error => {
                    console.error('Error fetching orders:', error);
                    const errorMessage = document.getElementById('errorMessage');
                    errorMessage.textContent = 'Ошибка загрузки заказов: ' + error.message;
                    errorMessage.style.display = 'block';
                });
            }
        }

        function fetchWorks(order, executorName) {
            console.log('Fetching works for order:', order);
            fetch('/works/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `executor_name=${encodeURIComponent(executorName)}&order=${encodeURIComponent(order)}`
            })
            .then(response => response.json())
            .then(data => {
                console.log('Works fetched:', data);
                const worksList = document.getElementById('worksList');
                worksList.innerHTML = '';
                const executorCode = document.getElementById('executor').value;

                if (currentSessionKey && sessions[currentSessionKey] && !sessions[currentSessionKey].isPaused && sessions[currentSessionKey].orderNumber === order) {
                    const activeWork = selectedWork || {
                        Code: sessions[currentSessionKey].workCode,
                        Work: sessions[currentSessionKey].workDescription,
                        WorkerCode: sessions[currentSessionKey].workerCode
                    };
                    const row = document.createElement('tr');
                    row.classList.add('fade-in');
                    row.innerHTML = `
                        <td>-</td>
                        <td>${activeWork.Code} ${activeWork.Work}</td>
                        <td>-</td>
                    `;
                    row.onclick = () => {
                        selectedWork = activeWork;
                        document.getElementById('startButton').disabled = true;
                        document.getElementById('pauseButton').disabled = false;
                        document.getElementById('pauseButton').textContent = 'Пауза';
                        document.getElementById('finishButton').disabled = false;
                        updateTimerDisplay(currentSessionKey);
                        console.log('Active work selected:', selectedWork);
                    };
                    worksList.appendChild(row);
                } else {
                    if (data.error) {
                        const row = document.createElement('tr');
                        row.classList.add('fade-in');
                        row.innerHTML = `<td colspan="3" class="text-danger">${data.error}</td>`;
                        worksList.appendChild(row);
                    } else if (data.works.length === 0) {
                        const row = document.createElement('tr');
                        row.classList.add('fade-in');
                        row.innerHTML = `<td colspan="3">Нет доступных работ</td>`;
                        worksList.appendChild(row);
                    } else {
                        data.works.forEach(work => {
                            const workerCode = (work.WorkerCode || executorCode).trim();
                            const workCode = (work.Code || '').trim();
                            const sessionKey = `${workerCode}-${order}-${workCode}`;
                            // Проверяем, нет ли работы в активных или паузах
                            const isPaused = Object.values(sessions).some(
                                session => session.orderNumber === order &&
                                           session.workerCode === workerCode &&
                                           session.workCode === workCode &&
                                           session.isPaused
                            );
                            const isActive = Object.values(sessions).some(
                                session => session.orderNumber === order &&
                                           session.workerCode === workerCode &&
                                           session.workCode === workCode &&
                                           !session.isPaused
                            );
                            if (isPaused || isActive) {
                                console.log(`Skipping work: ${workCode}, Paused: ${isPaused}, Active: ${isActive}`);
                                return;
                            }
                            // Отображаем только свободные работы
                            const row = document.createElement('tr');
                            row.classList.add('fade-in');
                            row.innerHTML = `
                                <td><input type="radio" name="work" value="${workCode}" data-seconds="${work.Sec}" data-time="${work.ZE}" data-worker-code="${workerCode}"></td>
                                <td>${workCode} ${work.Work}</td>
                                <td>${work.ZE}</td>
                            `;
                            row.onclick = () => {
                                const radio = row.querySelector('input[type="radio"]');
                                radio.checked = true;
                                selectedWork = { ...work, Code: workCode, WorkerCode: workerCode };
                                currentSessionKey = sessionKey;
                                const hasActiveWork = Object.values(sessions).some(session => !session.isPaused);
                                if (!hasActiveWork) {
                                    document.getElementById('startButton').disabled = false;
                                    document.getElementById('pauseButton').disabled = true;
                                    document.getElementById('pauseButton').textContent = 'Пауза';
                                    document.getElementById('finishButton').disabled = true;
                                } else {
                                    document.getElementById('startButton').disabled = true;
                                    document.getElementById('pauseButton').disabled = true;
                                    document.getElementById('finishButton').disabled = true;
                                }
                                console.log('Work selected:', selectedWork);
                            };
                            worksList.appendChild(row);
                        });
                    }
                }
                updatePausedWorks(executorName);
                updateInterfaceLock();
            })
            .catch(error => {
                console.error('Error fetching works:', error);
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Ошибка загрузки работ: ' + error.message;
                errorMessage.style.display = 'block';
            });
        }

        function updatePausedWorks(executorName) {
            const pausedWorksList = document.getElementById('pausedWorksList');
            pausedWorksList.innerHTML = '';
            const pausedSessions = Object.entries(sessions).filter(
                ([_, session]) => session.isPaused && session.orderNumber === selectedOrder
            );
            const executorCode = document.getElementById('executor').value;

            if (pausedSessions.length === 0) {
                const row = document.createElement('tr');
                row.classList.add('fade-in');
                row.innerHTML = `<td colspan="3">Нет работ на паузе</td>`;
                pausedWorksList.appendChild(row);
            } else {
                const uniqueSessions = {};
                pausedSessions.forEach(([sessionKey, session]) => {
                    uniqueSessions[sessionKey] = session;
                });

                Object.entries(uniqueSessions).forEach(([sessionKey, session]) => {
                    const [workerCodeRaw, orderNumber, workCode] = sessionKey.split('-');
                    const workerCode = (workerCodeRaw === 'undefined' || !workerCodeRaw) ? executorCode : workerCodeRaw;
                    const timeLeft = session.timeLeft;
                    let hours = Math.floor(Math.abs(timeLeft) / 3600);
                    let minutes = Math.floor((Math.abs(timeLeft) % 3600) / 60);
                    let secs = Math.abs(timeLeft) % 60;
                    const timeDisplay = `${timeLeft < 0 ? '-' : ''}${hours} ч. ${minutes} м. ${secs} с.`;
                    const row = document.createElement('tr');
                    row.classList.add('fade-in');
                    row.innerHTML = `
                        <td><input type="radio" name="pausedWork" value="${sessionKey}"></td>
                        <td>${workCode} ${session.workDescription || 'Работа на паузе'}</td>
                        <td>${timeDisplay}</td>
                    `;
                    row.onclick = () => {
                        const hasActiveWork = Object.values(sessions).some(s => !s.isPaused);
                        if (hasActiveWork) {
                            const errorMessage = document.getElementById('errorMessage');
                            errorMessage.textContent = 'Нельзя продолжить работу, пока другая работа активна.';
                            errorMessage.style.display = 'block';
                            return;
                        }
                        const radio = row.querySelector('input[type="radio"]');
                        radio.checked = true;
                        currentSessionKey = sessionKey;
                        selectedWork = {
                            Code: workCode,
                            WorkerCode: workerCode,
                            Work: session.workDescription || `${workCode} (восстановлено)`,
                            Sec: session.timeLeft
                        };
                        document.getElementById('startButton').disabled = true;
                        document.getElementById('pauseButton').disabled = false;
                        document.getElementById('pauseButton').textContent = 'Продолжить';
                        document.getElementById('finishButton').disabled = false;
                        updateTimerDisplay(sessionKey);
                        console.log('Paused work selected:', selectedWork);
                    };
                    pausedWorksList.appendChild(row);
                });
            }
            updateInterfaceLock();
        }

        function checkActiveSession(executorName) {
            fetch('/pause/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `action=check_all&executor=${encodeURIComponent(executorName)}`
            })
            .then(response => response.json())
            .then(data => {
                const worksList = document.getElementById('worksList');
                const ordersTable = document.getElementById('ordersTable');
                const executorCode = document.getElementById('executor').value;

                console.log('Sessions from backend:', data.sessions);
                Object.keys(sessions).forEach(key => {
                    if (sessions[key].timerInterval) clearInterval(sessions[key].timerInterval);
                    delete sessions[key];
                });
                currentSessionKey = null;
                selectedWork = null;

                if (data.sessions && data.sessions.length > 0) {
                    const uniqueSessions = {};
                    data.sessions.forEach(session => {
                        const workerCode = (session.worker_code || executorCode).trim();
                        const workCode = (session.work_code || '').trim();
                        const sessionKey = `${workerCode}-${session.order_number}-${workCode}`;
                        if (!uniqueSessions[sessionKey]) {
                            const intervals = JSON.parse(session.intervals || '[]');
                            const isPaused = !session.current_start;
                            uniqueSessions[sessionKey] = {
                                intervals: intervals,
                                currentStart: session.current_start || null,
                                timeLeft: session.time_left || 0,
                                isPaused: isPaused,
                                timerInterval: null,
                                workDescription: session.work_description || `${workCode} ${session.order_number}`,
                                orderNumber: session.order_number,
                                workCode: workCode,
                                workerCode: workerCode
                            };
                            console.log(`Added session: ${sessionKey}, Paused: ${isPaused}`);
                        } else {
                            console.warn(`Duplicate session detected: ${sessionKey}, skipping`);
                        }
                    });

                    let activeSession = null;
                    Object.entries(uniqueSessions).forEach(([sessionKey, session]) => {
                        sessions[sessionKey] = session;
                        if (!session.isPaused) {
                            activeSession = { sessionKey, session };
                        } else if (session.isPaused) {
                            console.log('Restored paused session:', sessionKey);
                        }
                    });

                    if (activeSession) {
                        const { sessionKey, session } = activeSession;
                        currentSessionKey = sessionKey;
                        selectedWork = {
                            Code: session.workCode,
                            Sec: session.timeLeft,
                            WorkerCode: session.workerCode,
                            Work: session.workDescription
                        };
                        selectedOrder = session.orderNumber;
                        console.log('Restoring active work:', selectedWork);

                        // Выделяем заказ в таблице заказов
                        const orderRows = ordersTable.querySelectorAll('tbody tr');
                        orderRows.forEach(row => {
                            const orderNumber = row.cells[0].textContent;
                            if (orderNumber === selectedOrder) {
                                row.classList.add('table-active');
                            } else {
                                row.classList.remove('table-active');
                            }
                        });

                        // Отображаем активную работу
                        worksList.innerHTML = '';
                        const row = document.createElement('tr');
                        row.classList.add('fade-in');
                        row.innerHTML = `
                            <td>-</td>
                            <td>${selectedWork.Code} ${selectedWork.Work}</td>
                            <td>-</td>
                        `;
                        row.onclick = () => {
                            currentSessionKey = sessionKey;
                            selectedWork = {
                                Code: session.workCode,
                                Sec: session.timeLeft,
                                WorkerCode: session.workerCode,
                                Work: session.workDescription
                            };
                            document.getElementById('startButton').disabled = true;
                            document.getElementById('pauseButton').disabled = false;
                            document.getElementById('pauseButton').textContent = 'Пауза';
                            document.getElementById('finishButton').disabled = false;
                            updateTimerDisplay(sessionKey);
                            console.log('Active work selected:', selectedWork);
                        };
                        worksList.appendChild(row);
                        startTimer(sessionKey);
                        console.log('Restored active session:', sessionKey);

                        // Загружаем описание заказа
                        fetch('/get_orders/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: 'executor_name=' + encodeURIComponent(executorName)
                        })
                        .then(response => response.json())
                        .then(data => {
                            const order = data.orders.find(o => o.OrderNumber === selectedOrder);
                            if (order) {
                                selectedOrderDescription = `${order.Order}${order.Car ? ', ' + order.Car : ''}`;
                            }
                            updatePausedWorks(executorName);
                            updateInterfaceLock();
                        })
                        .catch(error => {
                            console.error('Error fetching order description:', error);
                        });
                    } else {
                        worksList.innerHTML = '';
                        const row = document.createElement('tr');
                        row.classList.add('fade-in');
                        row.innerHTML = `<td colspan="3">Нет активных работ</td>`;
                        worksList.appendChild(row);
                        updatePausedWorks(executorName);
                        updateInterfaceLock();
                    }
                } else {
                    worksList.innerHTML = '';
                    const row = document.createElement('tr');
                    row.classList.add('fade-in');
                    row.innerHTML = `<td colspan="3">Нет активных работ</td>`;
                    worksList.appendChild(row);
                    resetTimer(null);
                    updatePausedWorks(executorName);
                    updateInterfaceLock();
                }
                console.log('Sessions after restore:', sessions);
            })
            .catch(error => {
                console.error('Error checking sessions:', error);
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Ошибка проверки сессий: ' + error.message;
                errorMessage.style.display = 'block';
            });
        }

        function startWork() {
            if (!selectedWork || !selectedOrderDescription || !selectedOrder) {
                console.error('No work or order selected');
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Выберите работу для начала.';
                errorMessage.style.display = 'block';
                return;
            }
            const executorName = document.getElementById('executor').options[document.getElementById('executor').selectedIndex].text;
            const executorCode = document.getElementById('executor').value;
            const workerCode = selectedWork.WorkerCode || executorCode;
            const sessionKey = `${workerCode}-${selectedOrder}-${selectedWork.Code}`;

            const hasActiveWork = Object.values(sessions).some(session => !session.isPaused);
            if (hasActiveWork) {
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'У вас уже есть активная работа. Завершите или поставьте её на паузу перед началом новой.';
                errorMessage.style.display = 'block';
                return;
            }

            if (sessions[sessionKey] && sessions[sessionKey].isPaused) {
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Эта работа уже на паузе. Продолжите её через список "Работы на паузе".';
                errorMessage.style.display = 'block';
                return;
            }

            fetch('/pause/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `action=check&executor=${encodeURIComponent(executorName)}&worknum=${encodeURIComponent(selectedWork.Code)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.session && data.session.is_active) {
                    const errorMessage = document.getElementById('errorMessage');
                    errorMessage.textContent = `Работа ${selectedWork.Code} уже взята.`;
                    errorMessage.style.display = 'block';
                    return;
                }

                if (!sessions[sessionKey]) {
                    const now = new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/,/, '');
                    const fullDescription = `Заказ наряд ${selectedOrder} от ${now}, ${selectedOrderDescription}, Номер заказа: ${selectedOrder} ${selectedWork.Code} ${selectedWork.Work}`;
                    sessions[sessionKey] = {
                        orderNumber: selectedOrder,
                        workCode: selectedWork.Code,
                        workerCode: workerCode,
                        timeLeft: parseInt(selectedWork.Sec) || 0,
                        intervals: [],
                        currentStart: now,
                        isPaused: false,
                        timerInterval: null,
                        workDescription: fullDescription
                    };
                    selectedWork.Work = fullDescription;
                    selectedWork.WorkerCode = workerCode;
                }

                currentSessionKey = sessionKey;
                document.getElementById('startButton').disabled = true;
                document.getElementById('pauseButton').disabled = false;
                document.getElementById('pauseButton').textContent = 'Пауза';
                document.getElementById('finishButton').disabled = false;

                const worksList = document.getElementById('worksList');
                worksList.innerHTML = '';
                const row = document.createElement('tr');
                row.classList.add('fade-in');
                row.innerHTML = `
                    <td>-</td>
                    <td>${selectedWork.Code} ${selectedWork.Work}</td>
                    <td>-</td>
                `;
                row.onclick = () => {
                    currentSessionKey = sessionKey;
                    document.getElementById('startButton').disabled = true;
                    document.getElementById('pauseButton').disabled = false;
                    document.getElementById('pauseButton').textContent = 'Пауза';
                    document.getElementById('finishButton').disabled = false;
                    console.log('Active work selected:', selectedWork);
                };
                worksList.appendChild(row);

                sendTo1C('start', sessionKey);
                startTimer(sessionKey);
                document.getElementById('errorMessage').style.display = 'none';
                updatePausedWorks(executorName);
            })
            .catch(error => {
                console.error('Error checking work status:', error);
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Ошибка проверки статуса работы: ' + error.message;
                errorMessage.style.display = 'block';
            });
        }

        function startTimer(sessionKey) {
            if (!sessions[sessionKey]) return;
            if (sessions[sessionKey].timerInterval) clearInterval(sessions[sessionKey].timerInterval);

            sessions[sessionKey].timerInterval = setInterval(() => {
                if (sessionKey === currentSessionKey && !sessions[sessionKey].isPaused) {
                    sessions[sessionKey].timeLeft -= 1;
                    updateTimerDisplay(sessionKey);
                }
            }, 1000);
        }

        function togglePause() {
            if (!currentSessionKey || !sessions[currentSessionKey]) {
                console.error('No current session to pause/resume');
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Выберите работу для паузы или продолжения.';
                errorMessage.style.display = 'block';
                return;
            }

            const pauseButton = document.getElementById('pauseButton');
            const executorName = document.getElementById('executor').options[document.getElementById('executor').selectedIndex].text;

            pauseButton.disabled = true;

            if (sessions[currentSessionKey].isPaused) {
                const hasActiveWork = Object.values(sessions).some(session => !session.isPaused && session !== sessions[currentSessionKey]);
                if (hasActiveWork) {
                    const errorMessage = document.getElementById('errorMessage');
                    errorMessage.textContent = 'Нельзя продолжить работу, пока другая работа активна.';
                    errorMessage.style.display = 'block';
                    pauseButton.disabled = false;
                    return;
                }
                sessions[currentSessionKey].currentStart = new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/,/, '');
                sessions[currentSessionKey].isPaused = false;
                startTimer(currentSessionKey);
                pauseButton.textContent = 'Пауза';
                pauseButton.disabled = false;
                document.getElementById('finishButton').disabled = false;
                sendTo1C('start', currentSessionKey);
                const worksList = document.getElementById('worksList');
                worksList.innerHTML = '';
                const row = document.createElement('tr');
                row.classList.add('fade-in');
                row.innerHTML = `
                    <td>-</td>
                    <td>${sessions[currentSessionKey].workCode} ${sessions[currentSessionKey].workDescription}</td>
                    <td>-</td>
                `;
                row.onclick = () => {
                    currentSessionKey = currentSessionKey;
                    selectedWork = {
                        Code: sessions[currentSessionKey].workCode,
                        Work: sessions[currentSessionKey].workDescription,
                        WorkerCode: sessions[currentSessionKey].workerCode,
                        Sec: sessions[currentSessionKey].timeLeft
                    };
                    document.getElementById('startButton').disabled = true;
                    document.getElementById('pauseButton').disabled = false;
                    document.getElementById('pauseButton').textContent = 'Пауза';
                    document.getElementById('finishButton').disabled = false;
                    updateTimerDisplay(currentSessionKey);
                    console.log('Active work selected:', selectedWork);
                };
                worksList.appendChild(row);
            } else {
                const pauseModal = new bootstrap.Modal(document.getElementById('pauseReasonModal'));
                loadPauseReasons();
                pauseModal.show();

                const confirmPauseButton = document.getElementById('confirmPause');
                const newConfirmPause = confirmPauseButton.cloneNode(true);
                confirmPauseButton.parentNode.replaceChild(newConfirmPause, confirmPauseButton);

                newConfirmPause.onclick = () => {
                    const selectedReason = document.querySelector('input[name="pauseReason"]:checked').value;
                    const endTime = new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/,/, '');

                    clearInterval(sessions[currentSessionKey].timerInterval);
                    sessions[currentSessionKey].intervals.push({
                        start: sessions[currentSessionKey].currentStart,
                        end: endTime,
                        reasonCode: selectedReason
                    });
                    sessions[currentSessionKey].currentStart = null;
                    sessions[currentSessionKey].isPaused = true;
                    pauseButton.textContent = 'Продолжить';
                    document.getElementById('finishButton').disabled = true;
                    document.getElementById('startButton').disabled = true;

                    sendTo1C('pause', currentSessionKey, selectedReason);
                    selectedWork = null;
                    fetchWorks(selectedOrder, executorName);
                    pauseModal.hide();
                    pauseButton.disabled = false;
                };
            }
            console.log('Pause toggled, intervals:', sessions[currentSessionKey]?.intervals);
            updatePausedWorks(executorName);
        }

        function finishWork() {
            if (!currentSessionKey || !sessions[currentSessionKey]) {
                console.error('No current session to finish');
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Выберите работу для завершения.';
                errorMessage.style.display = 'block';
                return;
            }

            const executorName = document.getElementById('executor').options[document.getElementById('executor').selectedIndex].text;
            const finishModal = new bootstrap.Modal(document.getElementById('finishConfirmationModal'));
            finishModal.show();

            document.getElementById('confirmFinish').onclick = () => {
                clearInterval(sessions[currentSessionKey].timerInterval);
                const endTime = new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/,/, '');

                if (sessions[currentSessionKey].currentStart) {
                    sessions[currentSessionKey].intervals.push({
                        start: sessions[currentSessionKey].currentStart,
                        end: endTime
                    });
                }
                sessions[currentSessionKey].currentStart = null;

                document.getElementById('startButton').disabled = true;
                document.getElementById('pauseButton').disabled = true;
                document.getElementById('pauseButton').textContent = 'Пауза';
                document.getElementById('finishButton').disabled = true;
                sendTo1C('finish', currentSessionKey);
                console.log('Work finished, intervals:', sessions[currentSessionKey].intervals);

                delete sessions[currentSessionKey];
                currentSessionKey = null;
                selectedWork = null;

                fetchWorks(selectedOrder, executorName);
                finishModal.hide();
                updatePausedWorks(executorName);
            };

            document.getElementById('cancelFinish').onclick = () => {
                finishModal.hide();
                document.getElementById('finishButton').focus();
            };
        }

        function updateTimerDisplay(sessionKey) {
            const timerDisplay = document.getElementById('timerDisplay');
            if (!sessions[sessionKey]) {
                timerDisplay.textContent = '';
                return;
            }
            const timeLeft = sessions[sessionKey].timeLeft;
            if (timeLeft >= 0) {
                let hours = Math.floor(timeLeft / 3600);
                let minutes = Math.floor((timeLeft % 3600) / 60);
                let secs = timeLeft % 60;
                timerDisplay.textContent = `Осталось: ${hours} ч. ${minutes} м. ${secs} с.`;
                timerDisplay.classList.remove('negative');
            } else {
                let absTimeLeft = Math.abs(timeLeft);
                let hours = Math.floor(absTimeLeft / 3600);
                let minutes = Math.floor((absTimeLeft % 3600) / 60);
                let secs = absTimeLeft % 60;
                timerDisplay.textContent = `Осталось: -${hours} ч. ${minutes} м. ${secs} с.`;
                timerDisplay.classList.add('negative');
            }
        }

        function resetTimer(sessionKey) {
            if (sessionKey && sessions[sessionKey] && sessions[sessionKey].timerInterval) {
                clearInterval(sessions[sessionKey].timerInterval);
            }
            document.getElementById('timerDisplay').textContent = '';
            document.getElementById('timerDisplay').classList.remove('negative');
            document.getElementById('startButton').disabled = true;
            document.getElementById('pauseButton').disabled = true;
            document.getElementById('pauseButton').textContent = 'Пауза';
            document.getElementById('finishButton').disabled = true;
            console.log('Timer reset, buttons disabled');
            updateInterfaceLock();
        }

        function sendTo1C(action, sessionKey, reasonCode = null) {
            let session = sessions[sessionKey];
            const executorName = document.getElementById('executor').options[document.getElementById('executor').selectedIndex].text;

            if (!session) {
                if (!selectedWork || !selectedWork.Code || !selectedWork.WorkerCode) {
                    console.error('Cannot start action: selectedWork is incomplete', selectedWork);
                    return;
                }
                const now = new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/,/, '');
                session = {
                    orderNumber: selectedOrder || '',
                    workCode: selectedWork.Code,
                    workerCode: selectedWork.WorkerCode,
                    intervals: [],
                    currentStart: now,
                    timeLeft: parseInt(selectedWork.Sec) || 0,
                    workDescription: `Заказ наряд ${selectedOrder} от ${now}, ${selectedOrderDescription}, Номер заказа: ${selectedOrder} ${selectedWork.Code} ${selectedWork.Work}`,
                    timerInterval: null,
                    isPaused: false
                };
                sessions[sessionKey] = session;
                console.log(`Created new session for ${sessionKey}:`, session);
            }

            const body = new URLSearchParams();
            body.append('action', action);
            body.append('ordernum', session.orderNumber || '');
            body.append('worknum', (session.workCode || '').trim());
            body.append('executor', executorName);
            body.append('worker_code', (session.workerCode || '').trim());
            body.append('time_left', session.timeLeft);
            body.append('work_description', session.workDescription);

            const now = new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/,/, '');
            let startTime = session.currentStart;
            if (action === 'pause' && !startTime && session.intervals.length > 0) {
                startTime = session.intervals[session.intervals.length - 1].start || '';
            }
            if (action === 'pause' && reasonCode) {
                body.append('start', startTime || '');
                body.append('end', now);
                body.append('reason_code', reasonCode);
            } else if (action === 'finish') {
                body.append('start', startTime || '');
                body.append('end', now);
            } else if (action === 'start') {
                body.append('start', startTime || now);
            }

            console.log(`Sending ${action} request:`, body.toString());
            fetch('/pause/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: body.toString()
            })
            .then(response => response.json())
            .then(data => {
                console.log(`${action} result:`, data);
                if (data.message && data.message.includes('1C server not available')) {
                    console.warn('1C server is not available, request logged to file');
                }
            })
            .catch(error => {
                console.error(`Error on ${action}:`, error);
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Ошибка отправки в 1C: ' + error.message;
                errorMessage.style.display = 'block';
            });
        }

        // Обработчик выбора сотрудника
        document.getElementById('executor').addEventListener('change', function() {
            const executorName = this.options[this.selectedIndex].text;
            fetchOrders();
        });
    </script>
</body>
</html>